<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBS Lower Thirds Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 10px;
            min-height: 100vh;
            font-size: 11px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 20px;
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .save-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #22c55e;
            color: white;
            border-radius: 8px;
            font-weight: 600;
            z-index: 9999;
            animation: toastIn 0.3s ease;
        }
        .save-toast.error { background: #ef4444; }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .global-controls {
            background: rgba(139, 92, 246, 0.15);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .global-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .global-controls h3 {
            font-size: 14px;
            margin: 0;
            color: #a78bfa;
        }

        .collapse-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
        }

        .collapse-icon.open {
            transform: rotate(180deg);
        }

        .global-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-top: 0;
        }

        .global-content.open {
            max-height: 500px;
            margin-top: 10px;
            transition: max-height 0.5s ease-in;
        }

        .global-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 8px;
            margin-bottom: 8px;
        }

        .global-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .global-group label {
            font-size: 10px;
            color: #d1d5db;
            font-weight: 500;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .panels-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 8px;
            margin-bottom: 10px;
        }

        .lower-third-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .panel-label-input {
            background: transparent;
            border: none;
            color: inherit;
            font-size: inherit;
            font-weight: inherit;
            padding: 0 4px;
            min-width: 80px;
            flex: 1;
        }
        .panel-label-input:focus {
            outline: 1px solid rgba(59, 130, 246, 0.5);
            border-radius: 4px;
        }

        .panel-number {
            background: linear-gradient(135deg, #3b82f6, #9333ea);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 11px;
        }

        .toggle-switch {
            position: relative;
            width: 36px;
            height: 18px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: 0.3s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background: linear-gradient(135deg, #3b82f6, #9333ea);
        }

        input:checked+.slider:before {
            transform: translateX(18px);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .form-group {
            margin-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-weight: 500;
            color: #e0e0e0;
            font-size: 10px;
        }

        input[type="text"],
        input[type="number"],
        input[type="color"],
        input[type="range"],
        select {
            width: 100%;
            padding: 5px 6px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            color: #ffffff;
            font-size: 11px;
            transition: all 0.3s;
        }

        input[type="color"] {
            height: 30px;
            cursor: pointer;
            padding: 2px;
        }

        input[type="range"] {
            padding: 0;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #3b82f6;
            background: rgba(255, 255, 255, 0.15);
        }

        select option {
            background: #2d2d2d;
            color: #ffffff;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-top: 8px;
        }

        button {
            padding: 6px 8px;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-show {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-show:hover {
            opacity: 0.9;
        }

        .btn-hide {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-hide:hover {
            opacity: 0.9;
        }

        .btn-clear {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
        }

        .btn-clear:hover {
            opacity: 0.9;
        }

        .btn-add,
        .btn-auto {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            margin: 8px auto;
            display: block;
        }

        .btn-auto {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .btn-auto.active {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .global-apply-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            width: 100%;
        }

        .global-apply-btn:hover {
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 5px;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: #10b981;
        }

        .status-inactive {
            background: #6b7280;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .settings-toggle {
            cursor: pointer;
            font-size: 10px;
            color: #a78bfa;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .settings-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .settings-content.open {
            max-height: 500px;
            transition: max-height 0.5s ease-in;
        }

        .gear-icon {
            transition: transform 0.3s ease;
        }

        .gear-icon.open {
            transform: rotate(90deg);
        }

        .drag-handle {
            cursor: grab;
            user-select: none;
            font-size: 14px;
            color: #9ca3af;
            margin-right: 6px;
            transition: color 0.3s;
        }

        .drag-handle:hover {
            color: #a78bfa;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .panel-dragging {
            opacity: 0.5;
            transform: scale(0.98);
        }

        .move-controls {
            display: flex;
            gap: 4px;
        }

        .btn-move {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 9px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-move:hover {
            opacity: 0.9;
        }

        .btn-move:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Scrollable settings fix */
        .settings-content {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0 0 6px 6px;
            margin-top: 5px;

            /* Hidden state defaults */
            max-height: 0;
            overflow: hidden;
            padding: 0 10px;
            opacity: 0;
            transition: all 0.3s ease-out;

            scrollbar-width: thin;
            scrollbar-color: #4b5563 rgba(0, 0, 0, 0.1);
        }

        .settings-content.open {
            /* Open state */
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            opacity: 1;
        }

        .settings-content::-webkit-scrollbar {
            width: 8px;
        }

        .settings-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .settings-content::-webkit-scrollbar-thumb {
            background-color: #4b5563;
            border-radius: 4px;
        }

        .btn-delete {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #fca5a5;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            margin-left: 8px;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: rgba(239, 68, 68, 0.4);
            color: #fff;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>OBS Lower Thirds Control</h1>

        <div class="global-controls">
            <div class="global-header" onclick="toggleGlobalSettings()">
                <h3>Global Settings (Apply to All)</h3>
                <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="global-content">
                <div class="global-row">
                    <div class="global-group">
                        <label>Auto Sequence Interval (sec)</label>
                        <input type="number" id="auto-interval" value="2" min="0" max="30" step="0.5">
                    </div>
                </div>
                <div class="global-row">
                    <div class="global-group">
                        <label>Transition</label>
                        <select id="global-transition">
                            <option value="slide">Slide</option>
                            <option value="bounce">Bounce</option>
                            <option value="fade">Fade</option>
                            <option value="swing">Swing</option>
                            <option value="flip">Flip</option>
                            <option value="elastic">Elastic</option>
                            <option value="zoom">Zoom</option>
                            <option value="rotate">Rotate</option>
                            <option value="wave">Wave</option>
                            <option value="glitch">Glitch</option>
                            <option value="curtain">Curtain</option>
                            <option value="scroll">Scroll</option>
                        </select>
                    </div>
                    <div class="global-group">
                        <label>Display Duration (sec)</label>
                        <input type="number" id="global-duration" value="5" min="1" max="60" step="0.5">
                    </div>
                    <div class="global-group">
                        <label>Animation In (sec)</label>
                        <input type="number" id="global-anim-in" value="0.8" min="0.1" max="5" step="0.1">
                    </div>
                    <div class="global-group">
                        <label>Animation Out (sec)</label>
                        <input type="number" id="global-anim-out" value="0.6" min="0.1" max="5" step="0.1">
                    </div>
                </div>
                <div class="global-row">
                    <div class="global-group">
                        <label>Font Family</label>
                        <select id="global-font-family">
                            <option value="Montserrat">Montserrat</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Raleway">Raleway</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                        </select>
                    </div>
                    <div class="global-group">
                        <label>Name Font Size (px)</label>
                        <input type="number" id="global-name-size" value="32" min="12" max="100" step="1">
                    </div>
                    <div class="global-group">
                        <label>Title Font Size (px)</label>
                        <input type="number" id="global-title-size" value="20" min="10" max="80" step="1">
                    </div>
                </div>
                <div class="global-row">
                    <div class="global-group">
                        <label>Background Style</label>
                        <select id="global-bg-style">
                            <option value="gradient1">Blue-Purple Gradient</option>
                            <option value="gradient2">Red-Orange Gradient</option>
                            <option value="gradient3">Green-Teal Gradient</option>
                            <option value="gradient4">Pink-Purple Gradient</option>
                            <option value="solid1">Solid Blue</option>
                            <option value="solid2">Solid Dark</option>
                            <option value="transparent">Transparent</option>
                            <option value="custom">Custom Color</option>
                        </select>
                    </div>
                    <div class="global-group">
                        <label>Transparency (%)</label>
                        <input type="number" id="global-transparency" value="95" min="0" max="100">
                    </div>
                    <div class="global-group" style="display: flex; align-items: flex-end;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin: 0;">
                            <input type="checkbox" id="global-typewriter" checked>
                            Typewriter Effect
                        </label>
                    </div>
                </div>
                <button class="global-apply-btn" onclick="applyGlobalSettings()">Apply to All Lower Thirds</button>
            </div>
        </div>

        <div class="panels-grid" id="panels-container">
            <!-- Panels will be generated here -->
        </div>

        <button class="btn-add" onclick="addPanel()">+ Add Lower Third Panel</button>
        <button class="btn-auto" id="auto-sequence-btn" onclick="toggleAutoSequence()">‚ñ∂ Start Auto Sequence</button>
    </div>

    <script>
        // WebSocket - comunica√ß√£o via servidor Node
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
        let ws = null;

        function connectWs() {
            ws = new WebSocket(wsUrl);
            ws.onopen = () => console.log('[Panel] WebSocket conectado');
            ws.onclose = () => {
                console.log('[Panel] WebSocket desconectado, reconectando em 2s...');
                setTimeout(connectWs, 2000);
            };
            ws.onerror = (e) => console.error('[Panel] WebSocket erro:', e);
        }
        connectWs();

        function sendToSource(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(data));
            } else {
                console.warn('[Panel] WebSocket n√£o conectado, mensagem n√£o enviada');
            }
        }

        function showToast(msg, isError = false) {
            const existing = document.querySelector('.save-toast');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'save-toast' + (isError ? ' error' : '');
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
        let panelCount = 4;
        const activeStates = {};
        const timers = {};
        let currentlyActive = null;
        let autoSequenceRunning = false;
        let autoSequenceInterval = null;
        let autoSequenceIndex = 0;
        let activePanelIds = [];

        async function init() {
            await loadSettings();
            // If no panels loaded, create defaults
            if (activePanelIds.length === 0) {
                for (let i = 1; i <= 4; i++) {
                    createPanel(i);
                    activePanelIds.push(i);
                }
                panelCount = 4;
                saveSettings(); // Save the default state
            }
            attachSaveListeners();
        }

        function createPanel(id) {
            const container = document.getElementById('panels-container');
            const panel = document.createElement('div');
            panel.className = 'lower-third-panel';
            panel.id = `panel-${id}`;
            panel.innerHTML = `
                <div class="panel-header">
                    <div class="panel-title">
                        <span class="drag-handle" draggable="true" data-panel-id="${id}">‚ãÆ‚ãÆ</span>
                        <div class="panel-number">${id}</div>
                        <input type="text" class="panel-label-input" id="panel-label-${id}" value="Lower Third ${id}" placeholder="Nome do painel">
                        <span class="status-indicator status-inactive" id="status-${id}"></span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div class="move-controls">
                            <button class="btn-move" onclick="movePanel(${id}, 'up')" title="Move Up">‚Üë</button>
                            <button class="btn-move" onclick="movePanel(${id}, 'down')" title="Move Down">‚Üì</button>
                        </div>
                        <button class="btn-delete" onclick="deletePanel(${id})" title="Delete Panel">üóëÔ∏è</button>
                        <label class="toggle-switch">
                            <input type="checkbox" id="toggle-${id}" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" id="name-${id}" placeholder="Enter name...">
                </div>
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="info-${id}" placeholder="Enter title...">
                </div>
                <div class="button-group">
                    <button class="btn-show" onclick="showLowerThird(${id})">Show</button>
                    <button class="btn-hide" onclick="hideLowerThird(${id})">Hide</button>
                    <button class="btn-clear" onclick="clearFields(${id})">Clear</button>
                </div>
                <div class="settings-toggle" onclick="toggleSettings(${id})">
                    <span class="gear-icon" id="gear-${id}">‚öôÔ∏è</span>
                    <span>Advanced Settings</span>
                </div>
                <div class="settings-content" id="settings-${id}">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Transition</label>
                            <select id="transition-${id}">
                                <option value="slide">Slide</option>
                                <option value="bounce">Bounce</option>
                                <option value="fade">Fade</option>
                                <option value="swing">Swing</option>
                                <option value="flip">Flip</option>
                                <option value="elastic">Elastic</option>
                                <option value="zoom">Zoom</option>
                                <option value="rotate">Rotate</option>
                                <option value="wave">Wave</option>
                                <option value="glitch">Glitch</option>
                                <option value="curtain">Curtain</option>
                                <option value="scroll">Scroll</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Duration (s)</label>
                            <input type="number" id="duration-${id}" value="5" min="1" max="60" step="0.5">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Anim In (s)</label>
                            <input type="number" id="anim-in-${id}" value="0.8" min="0.1" max="5" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Anim Out (s)</label>
                            <input type="number" id="anim-out-${id}" value="0.6" min="0.1" max="5" step="0.1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Font Family</label>
                        <select id="font-family-${id}">
                            <option value="Montserrat">Montserrat</option>
                            <option value="Poppins">Poppins</option>
                            <option value="Roboto">Roboto</option>
                            <option value="Open Sans">Open Sans</option>
                            <option value="Lato">Lato</option>
                            <option value="Oswald">Oswald</option>
                            <option value="Raleway">Raleway</option>
                            <option value="Arial">Arial</option>
                            <option value="Helvetica">Helvetica</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Times New Roman">Times New Roman</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name Size (px)</label>
                            <input type="number" id="name-size-${id}" value="32" min="12" max="100" step="1">
                        </div>
                        <div class="form-group">
                            <label>Title Size (px)</label>
                            <input type="number" id="title-size-${id}" value="20" min="10" max="80" step="1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name Text Color</label>
                            <input type="color" id="name-color-${id}" value="#ffffff">
                        </div>
                        <div class="form-group">
                            <label>Title Text Color</label>
                            <input type="color" id="title-color-${id}" value="#fbbf24">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Background Style</label>
                        <select id="bg-style-${id}" onchange="toggleCustomColor(${id})">
                            <option value="gradient1">Blue-Purple Gradient</option>
                            <option value="gradient2">Red-Orange Gradient</option>
                            <option value="gradient3">Green-Teal Gradient</option>
                            <option value="gradient4">Pink-Purple Gradient</option>
                            <option value="solid1">Solid Blue</option>
                            <option value="solid2">Solid Dark</option>
                            <option value="transparent">Transparent</option>
                            <option value="custom">Custom Color</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-color-group-${id}" style="display: none;">
                        <label>Custom Color</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="color" id="custom-color1-${id}" value="#3b82f6">
                            <input type="color" id="custom-color2-${id}" value="#9333ea">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Transparency: <span id="transparency-value-${id}">95</span>%</label>
                        <input type="range" id="transparency-${id}" min="0" max="100" value="95" oninput="updateTransparencyValue(${id})">
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="typewriter-${id}" checked>
                            Typewriter Effect
                        </label>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="logo-enabled-${id}">
                            Enable Logo
                        </label>
                    </div>
                    <div class="form-group" id="logo-settings-${id}" style="display: none;">
                        <label>Logo Image</label>
                        <div style="display: flex; gap: 5px;">
                            <input type="text" id="logo-url-${id}" placeholder="Click Browse or paste URL/path" style="flex: 1;">
                            <input type="file" id="logo-file-${id}" accept="image/*" style="display: none;">
                            <button type="button" class="btn-clear" onclick="browseLogo(${id})" style="padding: 6px 12px; white-space: nowrap;">Browse</button>
                        </div>
                    </div>
                    <div class="form-row" id="logo-controls-${id}" style="display: none;">
                        <div class="form-group">
                            <label>Logo Size (px)</label>
                            <input type="number" id="logo-size-${id}" value="60" min="20" max="200" step="5">
                        </div>
                        <div class="form-group">
                            <label>Logo Position</label>
                            <select id="logo-position-${id}">
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="logo-no-box-${id}">
                                Logo sem caixa
                            </label>
                        </div>
                    </div>
                </div>
                <div id="timer-${id}" style="text-align: center; margin-top: 5px; font-size: 11px; color: #fbbf24; height: 15px;"></div>
            `;
            container.appendChild(panel);

            // Attach logo toggle listener
            const logoToggle = document.getElementById(`logo-enabled-${id}`);
            if (logoToggle) {
                logoToggle.addEventListener('change', () => toggleLogoSettings(id));
            }

            // Attach file input listener
            const fileInput = document.getElementById(`logo-file-${id}`);
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            document.getElementById(`logo-url-${id}`).value = event.target.result;
                            saveSettings();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        }

        function browseLogo(id) {
            const fileInput = document.getElementById(`logo-file-${id}`);
            if (fileInput) {
                fileInput.click();
            }
        }

        function toggleLogoSettings(id) {
            const enabled = document.getElementById(`logo-enabled-${id}`).checked;
            const settingsEl = document.getElementById(`logo-settings-${id}`);
            const controlsEl = document.getElementById(`logo-controls-${id}`);

            if (enabled) {
                settingsEl.style.display = 'block';
                controlsEl.style.display = 'grid';
            } else {
                settingsEl.style.display = 'none';
                controlsEl.style.display = 'none';
            }
            saveSettings();
        }

        function deletePanel(id) {
            if (!confirm('Are you sure you want to delete Lower Third ' + id + '?')) return;

            const panel = document.getElementById(`panel-${id}`);
            if (panel) {
                // Hide it first
                hideLowerThird(id);

                // Remove from DOM
                panel.remove();

                // Remove from active list
                activePanelIds = activePanelIds.filter(pid => pid !== id);

                // Tell source to remove it (by hiding, source will eventually clean up or just stay hidden)
                const channelsMessage = { action: 'hide', id: id, animOut: 0 };
                sendToSource(channelsMessage);

                saveSettings();
            }
        }

        function addPanel() {
            panelCount++;
            createPanel(panelCount);
            activePanelIds.push(panelCount);
            attachSaveListeners();
            saveSettings();
        }

        function toggleSettings(id) {
            const content = document.getElementById(`settings-${id}`);
            const gear = document.getElementById(`gear-${id}`);
            content.classList.toggle('open');
            gear.classList.toggle('open');
        }

        function toggleGlobalSettings() {
            const content = document.querySelector('.global-content');
            const icon = document.querySelector('.collapse-icon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        function toggleCustomColor(id) {
            const style = document.getElementById(`bg-style-${id}`).value;
            const customGroup = document.getElementById(`custom-color-group-${id}`);
            customGroup.style.display = style === 'custom' ? 'block' : 'none';
        }

        function updateTransparencyValue(id) {
            const val = document.getElementById(`transparency-${id}`).value;
            document.getElementById(`transparency-value-${id}`).textContent = val;
        }

        function getBackground(id) {
            const style = document.getElementById(`bg-style-${id}`).value;
            const transparency = document.getElementById(`transparency-${id}`).value / 100;

            if (style === 'custom') {
                const c1 = document.getElementById(`custom-color1-${id}`).value;
                const c2 = document.getElementById(`custom-color2-${id}`).value;
                // Convert hex to rgba for transparency
                const hexToRgba = (hex, alpha) => {
                    const r = parseInt(hex.slice(1, 3), 16);
                    const g = parseInt(hex.slice(3, 5), 16);
                    const b = parseInt(hex.slice(5, 7), 16);
                    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
                };
                return `linear-gradient(135deg, ${hexToRgba(c1, transparency)}, ${hexToRgba(c2, transparency)})`;
            }

            const gradientMap = {
                gradient1: [[59, 130, 246], [147, 51, 234]],
                gradient2: [[239, 68, 68], [249, 115, 22]],
                gradient3: [[16, 185, 129], [20, 184, 166]],
                gradient4: [[236, 72, 153], [168, 85, 247]]
            };

            if (gradientMap[style]) {
                const colors = gradientMap[style];
                return `linear-gradient(135deg, rgba(${colors[0][0]}, ${colors[0][1]}, ${colors[0][2]}, ${transparency}), rgba(${colors[1][0]}, ${colors[1][1]}, ${colors[1][2]}, ${transparency}))`;
            }

            if (style === 'solid1') return `rgba(59, 130, 246, ${transparency})`;
            if (style === 'solid2') return `rgba(30, 30, 30, ${transparency})`;

            return `rgba(59, 130, 246, ${transparency})`;
        }

        function showLowerThird(id) {
            // Salva imediatamente todas as informa√ß√µes do painel no servidor
            saveSettings(true);

            const name = document.getElementById(`name-${id}`).value;
            const info = document.getElementById(`info-${id}`).value;
            const transition = document.getElementById(`transition-${id}`).value;
            const duration = parseFloat(document.getElementById(`duration-${id}`).value);
            const animIn = parseFloat(document.getElementById(`anim-in-${id}`).value);
            const animOut = parseFloat(document.getElementById(`anim-out-${id}`).value);
            const toggle = document.getElementById(`toggle-${id}`).checked;
            const background = getBackground(id);
            const typewriter = document.getElementById(`typewriter-${id}`).checked;
            const fontFamily = document.getElementById(`font-family-${id}`).value;
            const nameSize = document.getElementById(`name-size-${id}`).value;
            const titleSize = document.getElementById(`title-size-${id}`).value;
            const nameColor = document.getElementById(`name-color-${id}`).value;
            const titleColor = document.getElementById(`title-color-${id}`).value;
            const logoEnabled = document.getElementById(`logo-enabled-${id}`).checked;
            const logoUrl = document.getElementById(`logo-url-${id}`).value;
            const logoSize = document.getElementById(`logo-size-${id}`).value;
            const logoPosition = document.getElementById(`logo-position-${id}`).value;
            const logoNoBox = document.getElementById(`logo-no-box-${id}`)?.checked ?? false;

            if (!toggle) {
                alert(`Enable LT${id} first.`);
                return;
            }

            const hasText = name?.trim() || info?.trim();
            const hasLogo = logoEnabled && logoUrl?.trim();
            if (!hasText && !hasLogo) {
                alert('Preencha Name e Title, ou habilite um Logo.');
                return;
            }

            if (currentlyActive !== null && currentlyActive !== id) {
                hideLowerThird(currentlyActive);
            }

            sendToSource({
                action: 'show',
                id: id,
                name: name || '',
                info: info || '',
                transition: transition,
                animIn: animIn,
                animOut: animOut,
                background: background,
                typewriter: typewriter,
                fontFamily: fontFamily,
                nameSize: nameSize,
                titleSize: titleSize,
                nameColor: nameColor,
                titleColor: titleColor,
                logoEnabled: logoEnabled,
                logoUrl: logoUrl,
                logoSize: logoSize,
                logoPosition: logoPosition,
                logoNoBox: logoNoBox
            });

            activeStates[id] = true;
            currentlyActive = id;
            updateStatus(id);

            let timeLeft = duration;
            const timerEl = document.getElementById(`timer-${id}`);
            timerEl.textContent = `‚è±Ô∏è ${timeLeft.toFixed(1)}s`;

            if (timers[id]) clearInterval(timers[id]);

            timers[id] = setInterval(() => {
                timeLeft -= 0.1;
                if (timeLeft > 0) {
                    timerEl.textContent = `‚è±Ô∏è ${timeLeft.toFixed(1)}s`;
                } else {
                    clearInterval(timers[id]);
                    hideLowerThird(id);
                    timerEl.textContent = '';
                }
            }, 100);
        }

        function hideLowerThird(id) {
            const animOut = parseFloat(document.getElementById(`anim-out-${id}`).value);

            sendToSource({
                action: 'hide',
                id: id,
                animOut: animOut
            });

            activeStates[id] = false;
            if (currentlyActive === id) {
                currentlyActive = null;
            }
            updateStatus(id);

            if (timers[id]) {
                clearInterval(timers[id]);
                document.getElementById(`timer-${id}`).textContent = '';
            }
        }

        function clearFields(id) {
            document.getElementById(`name-${id}`).value = '';
            document.getElementById(`info-${id}`).value = '';
            saveSettings();
        }

        function updateStatus(id) {
            const statusEl = document.getElementById(`status-${id}`);
            if (activeStates[id]) {
                statusEl.classList.remove('status-inactive');
                statusEl.classList.add('status-active');
            } else {
                statusEl.classList.remove('status-active');
                statusEl.classList.add('status-inactive');
            }
        }

        function applyGlobalSettings() {
            const transition = document.getElementById('global-transition').value;
            const duration = document.getElementById('global-duration').value;
            const animIn = document.getElementById('global-anim-in').value;
            const animOut = document.getElementById('global-anim-out').value;
            const bgStyle = document.getElementById('global-bg-style').value;
            const transparency = document.getElementById('global-transparency').value;
            const typewriter = document.getElementById('global-typewriter').checked;
            const fontFamily = document.getElementById('global-font-family').value;
            const nameSize = document.getElementById('global-name-size').value;
            const titleSize = document.getElementById('global-title-size').value;

            for (let i = 1; i <= panelCount; i++) {
                const transitionEl = document.getElementById(`transition-${i}`);
                const durationEl = document.getElementById(`duration-${i}`);
                const animInEl = document.getElementById(`anim-in-${i}`);
                const animOutEl = document.getElementById(`anim-out-${i}`);
                const bgStyleEl = document.getElementById(`bg-style-${i}`);
                const transparencyEl = document.getElementById(`transparency-${i}`);
                const typewriterEl = document.getElementById(`typewriter-${i}`);
                const fontFamilyEl = document.getElementById(`font-family-${i}`);
                const nameSizeEl = document.getElementById(`name-size-${i}`);
                const titleSizeEl = document.getElementById(`title-size-${i}`);

                if (transitionEl) transitionEl.value = transition;
                if (durationEl) durationEl.value = duration;
                if (animInEl) animInEl.value = animIn;
                if (animOutEl) animOutEl.value = animOut;
                if (bgStyleEl) {
                    bgStyleEl.value = bgStyle;
                    toggleCustomColor(i);
                }
                if (transparencyEl) {
                    transparencyEl.value = transparency;
                    updateTransparencyValue(i);
                }
                if (typewriterEl) typewriterEl.checked = typewriter;
                if (fontFamilyEl) fontFamilyEl.value = fontFamily;
                if (nameSizeEl) nameSizeEl.value = nameSize;
                if (titleSizeEl) titleSizeEl.value = titleSize;
            }

            alert('‚úÖ Global settings applied to all lower thirds!');
            saveSettings();
        }

        function toggleAutoSequence() {
            autoSequenceRunning = !autoSequenceRunning;
            const btn = document.getElementById('auto-sequence-btn');

            if (autoSequenceRunning) {
                btn.textContent = '‚è∏ Stop Auto';
                btn.classList.add('active');
                startAutoSequence();
            } else {
                btn.textContent = '‚ñ∂ Start Auto';
                btn.classList.remove('active');
                stopAutoSequence();
            }
        }

        function startAutoSequence() {
            const enabledPanels = [];
            for (let i = 1; i <= panelCount; i++) {
                const toggle = document.getElementById(`toggle-${i}`);
                const name = document.getElementById(`name-${i}`)?.value;
                const info = document.getElementById(`info-${i}`)?.value;
                if (toggle && toggle.checked && name && info) {
                    enabledPanels.push(i);
                }
            }

            if (enabledPanels.length === 0) {
                alert('Enable and fill at least one lower third!');
                toggleAutoSequence();
                return;
            }

            autoSequenceIndex = 0;
            runAutoSequence(enabledPanels);
        }

        function runAutoSequence(enabledPanels) {
            if (!autoSequenceRunning) return;

            const id = enabledPanels[autoSequenceIndex];
            const duration = parseFloat(document.getElementById(`duration-${id}`).value);
            const interval = parseFloat(document.getElementById('auto-interval').value);

            showLowerThird(id);

            setTimeout(() => {
                if (!autoSequenceRunning) return;

                autoSequenceIndex = (autoSequenceIndex + 1) % enabledPanels.length;

                setTimeout(() => {
                    runAutoSequence(enabledPanels);
                }, interval * 1000);
            }, duration * 1000);
        }

        function stopAutoSequence() {
            if (autoSequenceInterval) {
                clearInterval(autoSequenceInterval);
                autoSequenceInterval = null;
            }
        }

        function movePanel(id, direction) {
            const container = document.getElementById('panels-container');
            const panels = Array.from(container.children);
            const panel = document.getElementById(`panel-${id}`);
            const index = panels.indexOf(panel);

            if (direction === 'up' && index > 0) {
                container.insertBefore(panel, panels[index - 1]);
                saveSettings();
            } else if (direction === 'down' && index < panels.length - 1) {
                container.insertBefore(panels[index + 1], panel);
                saveSettings();
            }
        }

        // ========== LOCALSTORAGE PERSISTENCE ==========

        let saveTimeout = null;

        function saveSettings(immediate = false) {
            const doSave = async () => {
                const settings = {
                    panels: {},
                    global: {},
                    panelCount: panelCount, // Maintains the MAX ID generated
                    activeIds: activePanelIds // Functionally track which ones exist
                };

                // Save each panel's settings
                activePanelIds.forEach(id => {
                    settings.panels[id] = savePanelSettings(id);
                });

                // Save global settings
                const globalInterval = document.getElementById('auto-interval');
                const globalTransition = document.getElementById('global-transition');
                const globalDuration = document.getElementById('global-duration');
                const globalAnimIn = document.getElementById('global-anim-in');
                const globalAnimOut = document.getElementById('global-anim-out');
                const globalBgStyle = document.getElementById('global-bg-style');
                const globalTransparency = document.getElementById('global-transparency');
                const globalTypewriter = document.getElementById('global-typewriter');
                const globalFontFamily = document.getElementById('global-font-family');
                const globalNameSize = document.getElementById('global-name-size');
                const globalTitleSize = document.getElementById('global-title-size');

                if (globalInterval) settings.global.autoInterval = globalInterval.value;
                if (globalTransition) settings.global.transition = globalTransition.value;
                if (globalDuration) settings.global.duration = globalDuration.value;
                if (globalAnimIn) settings.global.animIn = globalAnimIn.value;
                if (globalAnimOut) settings.global.animOut = globalAnimOut.value;
                if (globalBgStyle) settings.global.bgStyle = globalBgStyle.value;
                if (globalTransparency) settings.global.transparency = globalTransparency.value;
                if (globalTypewriter) settings.global.typewriter = globalTypewriter.checked;
                if (globalFontFamily) settings.global.fontFamily = globalFontFamily.value;
                if (globalNameSize) settings.global.nameSize = globalNameSize.value;
                if (globalTitleSize) settings.global.titleSize = globalTitleSize.value;

                try {
                    const res = await fetch('/api/settings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(settings)
                    });
                    if (res.ok) {
                        console.log('Settings saved to server');
                        localStorage.setItem('obs-lower-thirds-settings', JSON.stringify(settings));
                        showToast('Salvo! (servidor + backup local)');
                    } else {
                        throw new Error(await res.text());
                    }
                } catch (e) {
                    console.error('Erro ao salvar no servidor, usando localStorage:', e);
                    localStorage.setItem('obs-lower-thirds-settings', JSON.stringify(settings));
                    showToast('Salvo localmente (servidor indispon√≠vel)');
                }
            };

            if (immediate) {
                clearTimeout(saveTimeout);
                saveTimeout = null;
                doSave();
            } else {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(doSave, 300);
            }
        }

        function savePanelSettings(id) {
            const panel = {};

            const nameEl = document.getElementById(`name-${id}`);
            const infoEl = document.getElementById(`info-${id}`);
            const transitionEl = document.getElementById(`transition-${id}`);
            const durationEl = document.getElementById(`duration-${id}`);
            const animInEl = document.getElementById(`anim-in-${id}`);
            const animOutEl = document.getElementById(`anim-out-${id}`);
            const bgStyleEl = document.getElementById(`bg-style-${id}`);
            const transparencyEl = document.getElementById(`transparency-${id}`);
            const typewriterEl = document.getElementById(`typewriter-${id}`);
            const customColor1El = document.getElementById(`custom-color1-${id}`);
            const customColor2El = document.getElementById(`custom-color2-${id}`);
            const toggleEl = document.getElementById(`toggle-${id}`);
            const fontFamilyEl = document.getElementById(`font-family-${id}`);
            const nameSizeEl = document.getElementById(`name-size-${id}`);
            const titleSizeEl = document.getElementById(`title-size-${id}`);
            const nameColorEl = document.getElementById(`name-color-${id}`);
            const titleColorEl = document.getElementById(`title-color-${id}`);
            const logoEnabledEl = document.getElementById(`logo-enabled-${id}`);
            const logoUrlEl = document.getElementById(`logo-url-${id}`);
            const logoSizeEl = document.getElementById(`logo-size-${id}`);
            const logoPositionEl = document.getElementById(`logo-position-${id}`);
            const logoNoBoxEl = document.getElementById(`logo-no-box-${id}`);
            const panelLabelEl = document.getElementById(`panel-label-${id}`);

            if (nameEl) panel.name = nameEl.value;
            if (panelLabelEl) panel.panelLabel = panelLabelEl.value;
            if (infoEl) panel.info = infoEl.value;
            if (transitionEl) panel.transition = transitionEl.value;
            if (durationEl) panel.duration = durationEl.value;
            if (animInEl) panel.animIn = animInEl.value;
            if (animOutEl) panel.animOut = animOutEl.value;
            if (bgStyleEl) panel.bgStyle = bgStyleEl.value;
            if (transparencyEl) panel.transparency = transparencyEl.value;
            if (typewriterEl) panel.typewriter = typewriterEl.checked;
            if (customColor1El) panel.customColor1 = customColor1El.value;
            if (customColor2El) panel.customColor2 = customColor2El.value;
            if (toggleEl) panel.enabled = toggleEl.checked;
            if (fontFamilyEl) panel.fontFamily = fontFamilyEl.value;
            if (nameSizeEl) panel.nameSize = nameSizeEl.value;
            if (titleSizeEl) panel.titleSize = titleSizeEl.value;
            if (nameColorEl) panel.nameColor = nameColorEl.value;
            if (titleColorEl) panel.titleColor = titleColorEl.value;
            if (logoEnabledEl) panel.logoEnabled = logoEnabledEl.checked;
            if (logoUrlEl) panel.logoUrl = logoUrlEl.value;
            if (logoSizeEl) panel.logoSize = logoSizeEl.value;
            if (logoPositionEl) panel.logoPosition = logoPositionEl.value;
            if (logoNoBoxEl) panel.logoNoBox = logoNoBoxEl.checked;

            return panel;
        }

        async function loadSettings() {
            let settings = null;
            try {
                const res = await fetch('/api/settings');
                if (res.ok) {
                    settings = await res.json();
                    if (settings) {
                        console.log('Loading settings from server', settings);
                        showToast('Configura√ß√µes carregadas do servidor');
                    }
                }
            } catch (e) {
                console.log('Servidor indispon√≠vel, tentando localStorage:', e.message);
            }
            if (!settings) {
                const saved = localStorage.getItem('obs-lower-thirds-settings');
                if (saved) {
                    try {
                        settings = JSON.parse(saved);
                        console.log('Loading settings from localStorage', settings);
                        showToast('Configura√ß√µes carregadas (local)');
                    } catch (e) {
                        console.error('Erro ao parsear localStorage:', e);
                    }
                }
            }
            if (!settings) {
                console.log('No saved settings found');
                return;
            }

            try {
                // Restore panel max count generator
                if (settings.panelCount) {
                    panelCount = settings.panelCount;
                }

                // Restore active panels
                if (settings.activeIds && Array.isArray(settings.activeIds)) {
                    // Start fresh tracking
                    activePanelIds = [];

                    // Create needed panels
                    settings.activeIds.forEach(id => {
                        if (!document.getElementById(`panel-${id}`)) {
                            createPanel(id);
                        }
                        activePanelIds.push(id);

                        // Load data
                        if (settings.panels && settings.panels[id]) {
                            loadPanelSettings(id, settings.panels[id]);
                        }
                    });

                    // Cleanup any panels in DOM that aren't in activeIds (though createPanel is additive, let's be safe)
                    // ... implementation detail: if we started blank, we are fine. 

                } else {
                    // Legacy Fallback
                    if (settings.panelCount && settings.panelCount >= 1) {
                        const max = settings.panelCount >= 4 ? settings.panelCount : 4;
                        activePanelIds = [];
                        for (let i = 1; i <= max; i++) {
                            if (!document.getElementById(`panel-${i}`)) createPanel(i);
                            activePanelIds.push(i);
                            if (settings.panels && settings.panels[i]) {
                                loadPanelSettings(i, settings.panels[i]);
                            }
                        }
                    }
                }

                // Restore global settings
                if (settings.global) {
                    const globalInterval = document.getElementById('auto-interval');
                    const globalTransition = document.getElementById('global-transition');
                    const globalDuration = document.getElementById('global-duration');
                    const globalAnimIn = document.getElementById('global-anim-in');
                    const globalAnimOut = document.getElementById('global-anim-out');
                    const globalBgStyle = document.getElementById('global-bg-style');
                    const globalTransparency = document.getElementById('global-transparency');
                    const globalTypewriter = document.getElementById('global-typewriter');
                    const globalFontFamily = document.getElementById('global-font-family');
                    const globalNameSize = document.getElementById('global-name-size');
                    const globalTitleSize = document.getElementById('global-title-size');

                    if (globalInterval && settings.global.autoInterval !== undefined)
                        globalInterval.value = settings.global.autoInterval;
                    if (globalTransition && settings.global.transition)
                        globalTransition.value = settings.global.transition;
                    if (globalDuration && settings.global.duration !== undefined)
                        globalDuration.value = settings.global.duration;
                    if (globalAnimIn && settings.global.animIn !== undefined)
                        globalAnimIn.value = settings.global.animIn;
                    if (globalAnimOut && settings.global.animOut !== undefined)
                        globalAnimOut.value = settings.global.animOut;
                    if (globalBgStyle && settings.global.bgStyle)
                        globalBgStyle.value = settings.global.bgStyle;
                    if (globalTransparency && settings.global.transparency !== undefined)
                        globalTransparency.value = settings.global.transparency;
                    if (globalTypewriter && settings.global.typewriter !== undefined)
                        globalTypewriter.checked = settings.global.typewriter;
                    if (globalFontFamily && settings.global.fontFamily)
                        globalFontFamily.value = settings.global.fontFamily;
                    if (globalNameSize && settings.global.nameSize !== undefined)
                        globalNameSize.value = settings.global.nameSize;
                    if (globalTitleSize && settings.global.titleSize !== undefined)
                        globalTitleSize.value = settings.global.titleSize;
                }

                console.log('Settings loaded successfully');
            } catch (e) {
                console.error('Error loading settings:', e);
            }
        }

        function loadPanelSettings(id, panel) {
            const nameEl = document.getElementById(`name-${id}`);
            const infoEl = document.getElementById(`info-${id}`);
            const transitionEl = document.getElementById(`transition-${id}`);
            const durationEl = document.getElementById(`duration-${id}`);
            const animInEl = document.getElementById(`anim-in-${id}`);
            const animOutEl = document.getElementById(`anim-out-${id}`);
            const bgStyleEl = document.getElementById(`bg-style-${id}`);
            const transparencyEl = document.getElementById(`transparency-${id}`);
            const typewriterEl = document.getElementById(`typewriter-${id}`);
            const customColor1El = document.getElementById(`custom-color1-${id}`);
            const customColor2El = document.getElementById(`custom-color2-${id}`);
            const toggleEl = document.getElementById(`toggle-${id}`);
            const fontFamilyEl = document.getElementById(`font-family-${id}`);
            const nameSizeEl = document.getElementById(`name-size-${id}`);
            const titleSizeEl = document.getElementById(`title-size-${id}`);
            const nameColorEl = document.getElementById(`name-color-${id}`);
            const titleColorEl = document.getElementById(`title-color-${id}`);
            const logoEnabledEl = document.getElementById(`logo-enabled-${id}`);
            const logoUrlEl = document.getElementById(`logo-url-${id}`);
            const logoSizeEl = document.getElementById(`logo-size-${id}`);
            const logoPositionEl = document.getElementById(`logo-position-${id}`);
            const logoNoBoxEl = document.getElementById(`logo-no-box-${id}`);
            const panelLabelEl = document.getElementById(`panel-label-${id}`);

            if (nameEl && panel.name !== undefined) nameEl.value = panel.name;
            if (panelLabelEl && panel.panelLabel !== undefined) panelLabelEl.value = panel.panelLabel;
            if (infoEl && panel.info !== undefined) infoEl.value = panel.info;
            if (transitionEl && panel.transition) transitionEl.value = panel.transition;
            if (durationEl && panel.duration !== undefined) durationEl.value = panel.duration;
            if (animInEl && panel.animIn !== undefined) animInEl.value = panel.animIn;
            if (animOutEl && panel.animOut !== undefined) animOutEl.value = panel.animOut;
            if (bgStyleEl && panel.bgStyle) {
                bgStyleEl.value = panel.bgStyle;
                toggleCustomColor(id);
            }
            if (transparencyEl && panel.transparency !== undefined) {
                transparencyEl.value = panel.transparency;
                updateTransparencyValue(id);
            }
            if (typewriterEl && panel.typewriter !== undefined) typewriterEl.checked = panel.typewriter;
            if (customColor1El && panel.customColor1) customColor1El.value = panel.customColor1;
            if (customColor2El && panel.customColor2) customColor2El.value = panel.customColor2;
            if (toggleEl && panel.enabled !== undefined) toggleEl.checked = panel.enabled;
            if (fontFamilyEl && panel.fontFamily) fontFamilyEl.value = panel.fontFamily;
            if (nameSizeEl && panel.nameSize !== undefined) nameSizeEl.value = panel.nameSize;
            if (titleSizeEl && panel.titleSize !== undefined) titleSizeEl.value = panel.titleSize;
            if (nameColorEl && panel.nameColor) nameColorEl.value = panel.nameColor;
            if (titleColorEl && panel.titleColor) titleColorEl.value = panel.titleColor;
            if (logoEnabledEl && panel.logoEnabled !== undefined) {
                logoEnabledEl.checked = panel.logoEnabled;
                toggleLogoSettings(id);
            }
            if (logoUrlEl && panel.logoUrl) logoUrlEl.value = panel.logoUrl;
            if (logoSizeEl && panel.logoSize !== undefined) logoSizeEl.value = panel.logoSize;
            if (logoPositionEl && panel.logoPosition) logoPositionEl.value = panel.logoPosition;
            if (logoNoBoxEl && panel.logoNoBox !== undefined) logoNoBoxEl.checked = panel.logoNoBox;
        }

        function attachSaveListeners() {
            // Attach listeners to all inputs to auto-save on change
            document.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', saveSettings);
                if (element.type === 'text' || element.type === 'number') {
                    element.addEventListener('input', saveSettings);
                }
            });
        }

        // Expor fun√ß√µes para onclick em elementos est√°ticos (antes de init para garantir disponibilidade)
        window.addPanel = addPanel;
        window.toggleAutoSequence = toggleAutoSequence;
        window.toggleGlobalSettings = toggleGlobalSettings;
        window.applyGlobalSettings = applyGlobalSettings;

        init();
    </script>
</body>

</html>